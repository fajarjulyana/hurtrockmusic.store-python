

{% extends "admin/base.html" %}

{% block title %}Tambah Konfigurasi Pembayaran - Admin Dashboard{% endblock %}

{% block extra_head %}
<style>
.step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    align-items: center;
    position: relative;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--orange-primary);
    color: white;
}

.step.completed .step-number {
    background: #28a745;
    color: white;
}

.step-connector {
    width: 100px;
    height: 2px;
    background: #e9ecef;
    margin: 0 1rem;
}

.step.completed .step-connector {
    background: #28a745;
}

.step-title {
    position: absolute;
    top: 50px;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 0.9rem;
    font-weight: 600;
    color: #6c757d;
}

.step.active .step-title {
    color: var(--orange-primary);
}

.provider-card-wrapper {
    position: relative;
    height: 100%;
}

.provider-card {
    transition: all 0.3s ease;
    border: 3px solid #e9ecef;
    cursor: pointer;
    height: 100%;
    position: relative;
    overflow: visible;
    background: #fff;
}

.provider-card:hover {
    border-color: var(--orange-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
}

.provider-card.selected {
    border-color: var(--orange-primary) !important;
    background: rgba(255, 107, 53, 0.05) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.25) !important;
}

.provider-selection-indicator {
    position: absolute;
    top: -10px;
    right: -10px;
    background: var(--orange-primary);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    z-index: 10;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.provider-card.selected .provider-selection-indicator {
    display: flex !important;
    animation: bounceIn 0.3s ease;
}

.provider-card.selected .card-body::before {
    content: "TERPILIH";
    position: absolute;
    top: 15px;
    left: 15px;
    background: var(--orange-primary);
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.5px;
    z-index: 5;
}

@keyframes bounceIn {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.config-section {
    display: none;
}

.config-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.next-btn, .back-btn {
    min-width: 120px;
}

.next-btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.environment-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
}

.environment-card:hover {
    border-color: var(--orange-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
}

.environment-card.selected {
    border-color: var(--orange-primary) !important;
    background: rgba(255, 107, 53, 0.05) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2) !important;
}

.environment-card.selected::after {
    content: "âœ“";
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--orange-primary);
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.form-floating label {
    color: var(--text-muted);
}

.form-floating input:focus ~ label {
    color: var(--orange-primary);
}

.callback-info {
    background: rgba(255, 107, 53, 0.1);
    border-left: 4px solid var(--orange-primary);
}

.selection-feedback {
    border: none;
    border-radius: 10px;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    color: #155724;
    font-weight: 500;
    animation: slideInDown 0.3s ease;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.debug-info {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 9999;
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Debug Info -->
    <div id="debugInfo" class="debug-info"></div>
    
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-orange mb-0">
                <i class="fas fa-plus-circle me-2"></i>Tambah Konfigurasi Pembayaran
            </h2>
            <p class="text-muted mb-0">Siapkan gateway pembayaran untuk toko Anda</p>
        </div>
        <a href="{{ url_for('admin_payment_config') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Kembali
        </a>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step active" id="step1">
            <div class="step-number">1</div>
            <div class="step-title">Pilih Provider</div>
        </div>
        <div class="step-connector"></div>
        <div class="step" id="step2">
            <div class="step-number">2</div>
            <div class="step-title">Environment</div>
        </div>
        <div class="step-connector"></div>
        <div class="step" id="step3">
            <div class="step-number">3</div>
            <div class="step-title">Konfigurasi</div>
        </div>
        <div class="step-connector"></div>
        <div class="step" id="step4">
            <div class="step-number">4</div>
            <div class="step-title">Simpan</div>
        </div>
    </div>

    <form method="POST" id="paymentConfigForm">
        <!-- Step 1: Provider Selection -->
        <div class="card mb-4 config-section active" id="providerSection">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-credit-card me-2"></i>Langkah 1: Pilih Provider Pembayaran
                </h5>
                <small class="text-muted">Klik pada card untuk memilih provider pembayaran</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="provider-card-wrapper">
                            <div class="provider-card card h-100" data-provider="midtrans" id="midtransCard">
                                <div class="provider-selection-indicator">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="card-body text-center position-relative">
                                    <i class="fas fa-mobile-alt fa-3x text-info mb-3"></i>
                                    <h5>Midtrans</h5>
                                    <p class="text-muted mb-3">Payment gateway populer di Indonesia dengan berbagai metode pembayaran.</p>
                                    <div class="mt-3">
                                        <span class="badge bg-info">Virtual Account</span>
                                        <span class="badge bg-success">E-Wallet</span>
                                        <span class="badge bg-warning">Credit Card</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="provider-card-wrapper">
                            <div class="provider-card card h-100" data-provider="stripe" id="stripeCard">
                                <div class="provider-selection-indicator">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="card-body text-center position-relative">
                                    <i class="fab fa-stripe fa-3x text-primary mb-3"></i>
                                    <h5>Stripe</h5>
                                    <p class="text-muted mb-3">Platform pembayaran global dengan integrasi yang mudah dan aman.</p>
                                    <div class="mt-3">
                                        <span class="badge bg-primary">Credit Card</span>
                                        <span class="badge bg-secondary">International</span>
                                        <span class="badge bg-success">Secure</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="selectionStatus" class="mt-3" style="display: none;">
                    <div class="alert alert-success selection-feedback">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="selectionText"></span>
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-secondary next-btn" id="nextToEnvironment" disabled>
                        <i class="fas fa-arrow-right me-2"></i>Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Environment Selection -->
        <div class="card mb-4 config-section" id="environmentSection">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-server me-2"></i>Langkah 2: Pilih Environment
                </h5>
                <small class="text-muted">Pilih environment untuk konfigurasi pembayaran</small>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card environment-card" data-environment="sandbox">
                            <div class="card-body text-center">
                                <i class="fas fa-flask fa-2x text-warning mb-3"></i>
                                <h6><strong>Sandbox (Testing)</strong></h6>
                                <p class="text-muted small mb-0">Untuk pengembangan dan testing. Tidak ada transaksi uang sungguhan.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card environment-card" data-environment="production">
                            <div class="card-body text-center">
                                <i class="fas fa-rocket fa-2x text-success mb-3"></i>
                                <h6><strong>Production (Live)</strong></h6>
                                <p class="text-muted small mb-0">Untuk transaksi sungguhan. Pastikan semua konfigurasi sudah benar.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <button type="button" class="btn btn-outline-secondary back-btn" id="backToProvider">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                    <button type="button" class="btn btn-secondary next-btn" id="nextToConfig" disabled>
                        <i class="fas fa-arrow-right me-2"></i>Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Configuration -->
        <div class="card mb-4 config-section" id="configSection">
            <div class="card-header bg-light">
                <h5 class="mb-0" id="configTitle">
                    <i class="fas fa-cog me-2"></i>Langkah 3: Konfigurasi
                </h5>
            </div>
            <div class="card-body">
                <!-- Midtrans Configuration -->
                <div id="midtransConfig" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="midtrans_client_key" name="midtrans_client_key" placeholder="Client Key" required>
                                <label for="midtrans_client_key">Client Key *</label>
                            </div>
                            <small class="text-muted">Digunakan untuk komunikasi dari frontend</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="midtrans_server_key" name="midtrans_server_key" placeholder="Server Key" required>
                                <label for="midtrans_server_key">Server Key *</label>
                            </div>
                            <small class="text-muted">Digunakan untuk komunikasi server-to-server</small>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="midtrans_merchant_id" name="midtrans_merchant_id" placeholder="Merchant ID">
                                <label for="midtrans_merchant_id">Merchant ID (Opsional)</label>
                            </div>
                            <small class="text-muted">ID merchant Anda di Midtrans</small>
                        </div>
                    </div>

                    <div class="callback-info p-3 rounded mt-3">
                        <h6 class="mb-2">
                            <i class="fas fa-info-circle me-2"></i>URL Callback yang akan dikonfigurasi:
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="d-block">
                                    <strong>Finish URL:</strong><br>
                                    <code id="finishUrl"></code>
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="d-block">
                                    <strong>Error URL:</strong><br>
                                    <code id="errorUrl"></code>
                                </small>
                            </div>
                            <div class="col-md-4">
                                <small class="d-block">
                                    <strong>Notification URL:</strong><br>
                                    <code id="notificationUrl"></code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stripe Configuration -->
                <div id="stripeConfig" style="display: none;">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="text" class="form-control" id="stripe_publishable_key" name="stripe_publishable_key" placeholder="Publishable Key" required>
                                <label for="stripe_publishable_key">Publishable Key *</label>
                            </div>
                            <small class="text-muted">Digunakan untuk komunikasi dari frontend</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-floating">
                                <input type="password" class="form-control" id="stripe_secret_key" name="stripe_secret_key" placeholder="Secret Key" required>
                                <label for="stripe_secret_key">Secret Key *</label>
                            </div>
                            <small class="text-muted">Digunakan untuk komunikasi server-to-server</small>
                        </div>
                    </div>

                    <div class="callback-info p-3 rounded mt-3">
                        <h6 class="mb-2">
                            <i class="fas fa-info-circle me-2"></i>Webhook URL untuk Stripe:
                        </h6>
                        <p class="mb-0">
                            <strong>Webhook URL:</strong><br>
                            <code id="stripeWebhookUrl"></code>
                        </p>
                        <small class="text-muted mt-2 d-block">
                            Salin URL ini ke dashboard Stripe Anda untuk menerima notifikasi pembayaran.
                        </small>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary back-btn" id="backToEnvironment">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                    <button type="button" class="btn btn-orange next-btn" id="nextToSummary">
                        <i class="fas fa-arrow-right me-2"></i>Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Summary and Save -->
        <div class="card mb-4 config-section" id="summarySection">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Langkah 4: Ringkasan & Simpan
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="text-orange mb-3">Ringkasan Konfigurasi:</h6>
                        <div id="configSummary">
                            <!-- Summary content will be inserted here -->
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                                <h6>Konfigurasi Siap</h6>
                                <p class="small text-muted mb-0">Semua informasi sudah lengkap dan siap disimpan.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <button type="button" class="btn btn-outline-secondary back-btn" id="backToConfig">
                        <i class="fas fa-arrow-left me-2"></i>Kembali
                    </button>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Simpan Konfigurasi
                    </button>
                </div>
            </div>
        </div>

        <!-- Hidden inputs -->
        <input type="hidden" name="provider" id="selectedProvider">
        <input type="hidden" name="is_sandbox" id="selectedEnvironment">
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== Payment Config Script Loaded ===');
    
    // State variables
    let selectedProvider = null;
    let selectedEnvironment = null;
    let currentStep = 1;
    
    // Debug function
    function debug(message, data = null) {
        const debugInfo = document.getElementById('debugInfo');
        const timestamp = new Date().toLocaleTimeString();
        const debugText = `[${timestamp}] ${message}`;
        
        console.log(debugText, data);
        
        if (debugInfo) {
            debugInfo.innerHTML = debugText + (data ? ': ' + JSON.stringify(data) : '');
            debugInfo.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                debugInfo.style.display = 'none';
            }, 3000);
        }
    }
    
    // Get current domain for callback URLs
    const currentDomain = window.location.origin;
    
    // Update callback URL displays
    function updateCallbackUrls() {
        const elements = {
            finishUrl: currentDomain + '/payment/finish',
            errorUrl: currentDomain + '/payment/error',
            notificationUrl: currentDomain + '/payment/notification',
            stripeWebhookUrl: currentDomain + '/payment/notification'
        };
        
        Object.keys(elements).forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = elements[id];
            }
        });
    }
    
    // Initialize callback URLs
    updateCallbackUrls();
    
    // Provider selection function
    function selectProvider(providerValue) {
        debug('Selecting provider', providerValue);
        
        // Clear previous selections
        document.querySelectorAll('.provider-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Mark selected provider
        const selectedCard = document.querySelector(`[data-provider="${providerValue}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            selectedProvider = providerValue;
            
            // Update hidden input
            document.getElementById('selectedProvider').value = selectedProvider;
            
            // Show selection status
            showSelectionStatus(`Provider ${providerValue.charAt(0).toUpperCase() + providerValue.slice(1)} berhasil dipilih!`);
            
            // Enable next button
            enableNextButton('nextToEnvironment');
            
            debug('Provider selected successfully', {
                provider: selectedProvider,
                cardSelected: selectedCard.classList.contains('selected')
            });
        } else {
            debug('ERROR: Provider card not found', providerValue);
        }
    }
    
    // Environment selection function
    function selectEnvironment(environmentValue) {
        debug('Selecting environment', environmentValue);
        
        // Clear previous selections
        document.querySelectorAll('.environment-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Mark selected environment
        const selectedCard = document.querySelector(`[data-environment="${environmentValue}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
            selectedEnvironment = environmentValue === 'sandbox' ? 'true' : 'false';
            
            // Update hidden input
            document.getElementById('selectedEnvironment').value = selectedEnvironment;
            
            // Enable next button
            enableNextButton('nextToConfig');
            
            debug('Environment selected successfully', {
                environment: environmentValue,
                isSandbox: selectedEnvironment
            });
        }
    }
    
    // Show selection status
    function showSelectionStatus(message) {
        const statusDiv = document.getElementById('selectionStatus');
        const statusText = document.getElementById('selectionText');
        
        if (statusDiv && statusText) {
            statusText.textContent = message;
            statusDiv.style.display = 'block';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // Enable next button
    function enableNextButton(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = false;
            button.classList.remove('btn-secondary');
            button.classList.add('btn-orange');
            debug(`Button ${buttonId} enabled`);
        }
    }
    
    // Disable next button
    function disableNextButton(buttonId) {
        const button = document.getElementById(buttonId);
        if (button) {
            button.disabled = true;
            button.classList.remove('btn-orange');
            button.classList.add('btn-secondary');
            debug(`Button ${buttonId} disabled`);
        }
    }
    
    // Provider card click handlers - Multiple event listeners for redundancy
    document.querySelectorAll('.provider-card').forEach(card => {
        // Click event
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const provider = this.getAttribute('data-provider');
            debug('Provider card clicked', provider);
            selectProvider(provider);
        });
        
        // Double click event as backup
        card.addEventListener('dblclick', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const provider = this.getAttribute('data-provider');
            debug('Provider card double-clicked', provider);
            selectProvider(provider);
        });
        
        // Touch events for mobile
        card.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const provider = this.getAttribute('data-provider');
            debug('Provider card touched', provider);
            selectProvider(provider);
        });
    });
    
    // Environment card click handlers
    document.querySelectorAll('.environment-card').forEach(card => {
        card.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const environment = this.getAttribute('data-environment');
            debug('Environment card clicked', environment);
            selectEnvironment(environment);
        });
    });
    
    // Navigation button handlers
    document.getElementById('nextToEnvironment').addEventListener('click', function() {
        debug('Next to environment clicked', { selectedProvider });
        if (selectedProvider) {
            goToStep(2);
        } else {
            alert('Silakan pilih provider pembayaran terlebih dahulu!');
            debug('ERROR: No provider selected');
        }
    });
    
    document.getElementById('backToProvider').addEventListener('click', function() {
        debug('Back to provider clicked');
        goToStep(1);
    });
    
    document.getElementById('nextToConfig').addEventListener('click', function() {
        debug('Next to config clicked', { selectedEnvironment });
        if (selectedEnvironment !== null) {
            goToStep(3);
            setupConfigSection();
        } else {
            alert('Silakan pilih environment terlebih dahulu!');
            debug('ERROR: No environment selected');
        }
    });
    
    document.getElementById('backToEnvironment').addEventListener('click', function() {
        debug('Back to environment clicked');
        goToStep(2);
    });
    
    document.getElementById('nextToSummary').addEventListener('click', function() {
        debug('Next to summary clicked');
        if (validateCurrentConfig()) {
            goToStep(4);
            setupSummarySection();
        }
    });
    
    document.getElementById('backToConfig').addEventListener('click', function() {
        debug('Back to config clicked');
        goToStep(3);
    });
    
    // Step navigation function
    function goToStep(step) {
        debug('Going to step', step);
        
        // Hide all sections
        document.querySelectorAll('.config-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Update step indicators
        document.querySelectorAll('.step').forEach((stepEl, index) => {
            stepEl.classList.remove('active', 'completed');
            if (index + 1 < step) {
                stepEl.classList.add('completed');
            } else if (index + 1 === step) {
                stepEl.classList.add('active');
            }
        });
        
        // Show current section
        const sections = ['', 'providerSection', 'environmentSection', 'configSection', 'summarySection'];
        const targetSection = document.getElementById(sections[step]);
        if (targetSection) {
            targetSection.classList.add('active');
        }
        
        currentStep = step;
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Setup configuration section
    function setupConfigSection() {
        debug('Setting up config section', { selectedProvider });
        
        const configTitle = document.getElementById('configTitle');
        const midtransConfig = document.getElementById('midtransConfig');
        const stripeConfig = document.getElementById('stripeConfig');
        
        // Hide all config forms
        midtransConfig.style.display = 'none';
        stripeConfig.style.display = 'none';
        
        if (selectedProvider === 'midtrans') {
            configTitle.innerHTML = '<i class="fas fa-mobile-alt me-2 text-info"></i>Langkah 3: Konfigurasi Midtrans';
            midtransConfig.style.display = 'block';
        } else if (selectedProvider === 'stripe') {
            configTitle.innerHTML = '<i class="fab fa-stripe me-2 text-primary"></i>Langkah 3: Konfigurasi Stripe';
            stripeConfig.style.display = 'block';
        }
    }
    
    // Validate current configuration
    function validateCurrentConfig() {
        debug('Validating config', { selectedProvider });
        
        if (selectedProvider === 'midtrans') {
            const clientKey = document.getElementById('midtrans_client_key').value.trim();
            const serverKey = document.getElementById('midtrans_server_key').value.trim();
            
            if (!clientKey || !serverKey) {
                alert('Client Key dan Server Key harus diisi untuk Midtrans.');
                return false;
            }
        } else if (selectedProvider === 'stripe') {
            const publishableKey = document.getElementById('stripe_publishable_key').value.trim();
            const secretKey = document.getElementById('stripe_secret_key').value.trim();
            
            if (!publishableKey || !secretKey) {
                alert('Publishable Key dan Secret Key harus diisi untuk Stripe.');
                return false;
            }
        }
        
        return true;
    }
    
    // Setup summary section
    function setupSummarySection() {
        debug('Setting up summary section');
        
        const summaryDiv = document.getElementById('configSummary');
        const environmentText = selectedEnvironment === 'true' ? 'Sandbox (Testing)' : 'Production (Live)';
        
        let summaryHtml = `
            <div class="mb-3">
                <strong>Provider:</strong> ${selectedProvider.charAt(0).toUpperCase() + selectedProvider.slice(1)}<br>
                <strong>Environment:</strong> <span class="badge ${selectedEnvironment === 'true' ? 'bg-warning' : 'bg-success'}">${environmentText}</span>
            </div>
        `;
        
        if (selectedProvider === 'midtrans') {
            const clientKey = document.getElementById('midtrans_client_key').value;
            const serverKey = document.getElementById('midtrans_server_key').value;
            const merchantId = document.getElementById('midtrans_merchant_id').value;
            
            summaryHtml += `
                <div class="mb-2">
                    <strong>Client Key:</strong> ${clientKey.substring(0, 10)}*****
                </div>
                <div class="mb-2">
                    <strong>Server Key:</strong> ${serverKey.substring(0, 10)}*****
                </div>
                ${merchantId ? `<div class="mb-2"><strong>Merchant ID:</strong> ${merchantId}</div>` : ''}
            `;
        } else if (selectedProvider === 'stripe') {
            const publishableKey = document.getElementById('stripe_publishable_key').value;
            const secretKey = document.getElementById('stripe_secret_key').value;
            
            summaryHtml += `
                <div class="mb-2">
                    <strong>Publishable Key:</strong> ${publishableKey.substring(0, 10)}*****
                </div>
                <div class="mb-2">
                    <strong>Secret Key:</strong> ${secretKey.substring(0, 10)}*****
                </div>
            `;
        }
        
        summaryDiv.innerHTML = summaryHtml;
    }
    
    // Form submission
    document.getElementById('paymentConfigForm').addEventListener('submit', function(e) {
        debug('Form submitted');
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Menyimpan...';
        submitBtn.disabled = true;
    });
    
    // Auto-select Midtrans if needed (for testing)
    setTimeout(() => {
        debug('Auto-selecting Midtrans for testing');
        // Uncomment for auto-testing
        // selectProvider('midtrans');
    }, 1000);
    
    debug('Script initialization completed');
});
</script>
{% endblock %}

