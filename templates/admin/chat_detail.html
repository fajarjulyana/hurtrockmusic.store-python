{% extends "admin/base.html" %} {% block title %}Chat dengan {{
chat_room.user.name }} - Admin Panel{% endblock %} {% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<meta name="csrf-token" content="{{ csrf_token() }}" />
<style>
    .chat-container-wrapper {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        height: 85vh;
        display: flex;
        flex-direction: column;
    }
    .chat-header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 16px 20px;
    }
    .customer-info h5 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
    }
    .chat-actions a {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 6px 12px;
        color: white;
        font-size: 14px;
        text-decoration: none;
    }
    .chat-actions a:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f9fafb;
    }
    .message-bubble {
        margin-bottom: 12px;
        display: flex;
    }
    .message-bubble.user {
        justify-content: flex-start;
    }
    .message-bubble.admin {
        justify-content: flex-end;
    }
    .message-text {
        padding: 10px 14px;
        border-radius: 16px;
        max-width: 65%;
        line-height: 1.4;
    }
    .message-bubble.user .message-text {
        background: #fff;
        border: 1px solid #e5e7eb;
        color: #374151;
        border-bottom-left-radius: 4px;
    }
    .message-bubble.admin .message-text {
        background: #4f46e5;
        color: #fff;
        border-bottom-right-radius: 4px;
    }
    .message-time {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 4px;
    }
    .chat-input-section {
        padding: 12px 16px;
        border-top: 1px solid #e5e7eb;
        background: white;
        display: flex;
        gap: 8px;
    }
    .message-input {
        flex: 1;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 10px;
        resize: none;
        font-size: 14px;
    }
    .send-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: #4f46e5;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %} {% block content %}
<div class="chat-container-wrapper">
    <!-- Header -->
    <div class="chat-header d-flex justify-content-between align-items-center">
        <div class="customer-info">
            <h5>{{ chat_room.user.name }}</h5>
            <small>{{ chat_room.user.email }}</small>
        </div>
        <div class="chat-actions">
            <a href="{{ url_for('admin_chats') }}"
                ><i class="fas fa-arrow-left me-1"></i>Back</a
            >
        </div>
    </div>

    <!-- Messages -->
    <div class="chat-messages" id="adminChatMessages">
        {% if messages %} {% for message in messages %}
        <div class="message-bubble {{ message.sender_type }}">
            <div>
                <div class="message-text">{{ message.message }}</div>
                <div class="message-time">
                    {{ message.created_at.strftime('%H:%M') }}
                </div>
            </div>
        </div>
        {% endfor %} {% else %}
        <div class="text-center text-muted py-5">
            <i class="fas fa-comments fa-2x mb-2"></i>
            <p>Belum ada percakapan</p>
        </div>
        {% endif %}
    </div>

    <!-- Input -->
    <div class="chat-input-section">
        <textarea
            id="adminChatInput"
            class="message-input"
            placeholder="Tulis pesan..."
            rows="1"
        ></textarea>
        <button type="button" id="sendAdminMessage" class="send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>

    <input type="hidden" id="roomId" value="{{ chat_room.id }}" />
</div>
{% endblock %} {% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    console.log("Admin chat detail script loaded");

    const adminChatMessages = document.getElementById("adminChatMessages");
    const adminChatInput = document.getElementById("adminChatInput");
    const sendAdminMessageBtn = document.getElementById("sendAdminMessage");
    const roomId = document.getElementById("roomId").value;
    let socket;

    console.log("Elements found:", {
        messages: !!adminChatMessages,
        input: !!adminChatInput,
        button: !!sendAdminMessageBtn,
        roomId: roomId
    });

    // Initialize Socket.IO
    if (typeof io !== 'undefined') {
        socket = io();
        socket.emit('join', {});
        console.log("Socket.IO initialized");

        socket.on('new_message', function(data) {
            if (data.sender_type === 'user') {
                addMessage(data.message, 'user', data.timestamp);
                console.log("Received user message via socket:", data);
            }
        });
    }

    function updateSendButtonState() {
        if (adminChatInput && sendAdminMessageBtn) {
            const isEmpty = adminChatInput.value.trim().length === 0;
            sendAdminMessageBtn.disabled = isEmpty;
            console.log("Button state updated. Disabled:", isEmpty);
        }
    }

    function scrollToBottom() {
        if (adminChatMessages) {
            setTimeout(() => {
                adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            }, 100);
        }
    }

    function addMessage(message, sender, timestamp = null) {
        if (!adminChatMessages) return;

        const div = document.createElement("div");
        div.className = `message-bubble ${sender}`;
        const timeStr = timestamp || new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });

        // Escape HTML to prevent XSS
        const safeMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        div.innerHTML = `
        <div>
            <div class="message-text">${safeMessage}</div>
            <div class="message-time">${timeStr}</div>
        </div>`;

        adminChatMessages.appendChild(div);
        scrollToBottom();
    }

    function sendMessage() {
        if (!adminChatInput || !sendAdminMessageBtn || !roomId) {
            console.error("Required elements not found");
            return;
        }

        const message = adminChatInput.value.trim();
        console.log("Attempting to send message:", message);

        if (!message) {
            console.log("Message is empty, not sending");
            return;
        }

        // Disable button and show loading
        sendAdminMessageBtn.disabled = true;
        const originalIcon = sendAdminMessageBtn.innerHTML;
        sendAdminMessageBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        // Clear input immediately
        adminChatInput.value = "";

        // Send to server using URLSearchParams for better compatibility
        const params = new URLSearchParams();
        params.append('room_id', roomId);
        params.append('message', message);

        console.log("Sending to server:", { room_id: roomId, message: message });

        fetch("/admin/send_reply", {
            method: "POST",
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: params,
            credentials: "same-origin"
        })
        .then(response => {
            console.log("Server response status:", response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Server response:", data);
            if (data.success) {
                // Add message to chat
                const timestamp = data.timestamp || new Date().toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
                addMessage(message, "admin", timestamp);
                console.log("Message sent successfully");
            } else {
                console.error("Server error:", data.error || 'Unknown error');
                alert("Error: " + (data.error || 'Failed to send message'));
                // Restore message to input on error
                adminChatInput.value = message;
            }
        })
        .catch(error => {
            console.error("Error sending message:", error);
            alert("Failed to send message: " + error.message);
            // Restore message to input on error
            adminChatInput.value = message;
        })
        .finally(() => {
            // Restore button state
            sendAdminMessageBtn.innerHTML = originalIcon;
            updateSendButtonState();
        });
    }

    // Event listeners with proper error handling
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, setting up event listeners");

        if (adminChatInput) {
            adminChatInput.addEventListener("input", updateSendButtonState);

            // Send on Enter (but allow Shift+Enter for new lines)
            adminChatInput.addEventListener("keypress", function(e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                    return false;
                }
            });
        }

        if (sendAdminMessageBtn) {
            sendAdminMessageBtn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("Send button clicked");
                sendMessage();
            });
        }

        // Initialize
        updateSendButtonState();
        scrollToBottom();

        console.log("Admin chat script initialized successfully");
    });

    // Fallback initialization if DOM is already loaded
    if (document.readyState === 'loading') {
        console.log("DOM still loading, waiting...");
    } else {
        console.log("DOM already loaded, initializing immediately");

        if (adminChatInput) {
            adminChatInput.addEventListener("input", updateSendButtonState);
            adminChatInput.addEventListener("keypress", function(e) {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    e.stopPropagation();
                    sendMessage();
                    return false;
                }
            });
        }

        if (sendAdminMessageBtn) {
            sendAdminMessageBtn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log("Send button clicked");
                sendMessage();
            });
        }

        updateSendButtonState();
        scrollToBottom();
    }

    // Global error handler for debugging
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
    });

    console.log("Admin chat script loaded completely");
</script>
{% endblock %}