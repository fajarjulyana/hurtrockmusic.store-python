
{% extends "admin/base.html" %}

{% block title %}Kelola Restock - Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <svg class="admin-svg-icon me-2 text-orange" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14.5 2H6C5.5 2 5 2.5 5 3V21C5 21.5 5.5 22 6 22H18C18.5 22 19 21.5 19 21V7.5L14.5 2Z" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" fill="none"/>
            <path d="M16 13H8M16 17H8M10 9H8" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>Kelola Restock Orders
    </h2>
    <button class="btn btn-orange" data-bs-toggle="modal" data-bs-target="#createRestockModal">
        <i class="fas fa-plus me-2"></i>Buat Restock Order
    </button>
</div>

<!-- Restock Orders Table -->
<div class="card shadow-sm border-0">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Order ID</th>
                        <th>Supplier</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Tanggal Order</th>
                        <th>Expected Date</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in restock_orders %}
                    <tr>
                        <td><strong>RST-{{ "%05d"|format(order.id) }}</strong></td>
                        <td>
                            <strong>{{ order.supplier.name }}</strong>
                            {% if order.supplier.contact_person %}
                                <br><small class="text-muted">{{ order.supplier.contact_person }}</small>
                            {% endif %}
                        </td>
                        <td>{{ order.formatted_total }}</td>
                        <td>
                            {% if order.status == 'pending' %}
                                <span class="badge bg-warning">Pending</span>
                            {% elif order.status == 'ordered' %}
                                <span class="badge bg-info">Ordered</span>
                            {% elif order.status == 'received' %}
                                <span class="badge bg-success">Received</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge bg-danger">Cancelled</span>
                            {% endif %}
                        </td>
                        <td>{{ order.created_at.strftime('%d/%m/%Y') }}</td>
                        <td>
                            {% if order.expected_date %}
                                {{ order.expected_date.strftime('%d/%m/%Y') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info" onclick="viewRestockOrder({{ order.id }})" data-bs-toggle="modal" data-bs-target="#viewRestockModal">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="updateStatus({{ order.id }})" data-bs-toggle="modal" data-bs-target="#updateStatusModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="{{ url_for('admin_generate_restock_invoice', order_id=order.id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-print"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create Restock Order Modal -->
<div class="modal fade" id="createRestockModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Buat Restock Order Baru</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_create_restock_order') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Supplier *</label>
                                <select class="form-select" name="supplier_id" required>
                                    <option value="">Pilih Supplier</option>
                                    {% for supplier in suppliers %}
                                        <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Expected Date</label>
                                <input type="date" class="form-control" name="expected_date">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Catatan</label>
                        <textarea class="form-control" name="notes" rows="2"></textarea>
                    </div>
                    
                    <h6 class="mt-4 mb-3">Items</h6>
                    <div id="restock-items">
                        <div class="row restock-item-row">
                            <div class="col-md-5">
                                <select class="form-select" name="product_ids[]" required>
                                    <option value="">Pilih Produk</option>
                                    {% for product in products %}
                                        <option value="{{ product.id }}">{{ product.name }} - Stock: {{ product.stock_quantity }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="number" class="form-control" name="quantities[]" placeholder="Qty" min="1" required>
                            </div>
                            <div class="col-md-3">
                                <input type="number" class="form-control" name="unit_costs[]" placeholder="Harga Satuan" min="0" step="1000" required>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeRestockItem(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="addRestockItem()">
                        <i class="fas fa-plus me-1"></i>Tambah Item
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-orange">Buat Order</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status Restock Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateStatusForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="ordered">Ordered</option>
                            <option value="received">Received</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-orange">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Restock Order Modal -->
<div class="modal fade" id="viewRestockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detail Restock Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewRestockContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
const restockOrders = {{ restock_orders_data | tojson }};
const products = {{ products_data | tojson }};

function addRestockItem() {
    const container = document.getElementById('restock-items');
    const newRow = document.createElement('div');
    newRow.className = 'row restock-item-row mt-2';
    
    newRow.innerHTML = `
        <div class="col-md-5">
            <select class="form-select" name="product_ids[]" required>
                <option value="">Pilih Produk</option>
                {% for product in products %}
                    <option value="{{ product.id }}">{{ product.name }} - Stock: {{ product.stock_quantity }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="quantities[]" placeholder="Qty" min="1" required>
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="unit_costs[]" placeholder="Harga Satuan" min="0" step="1000" required>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeRestockItem(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(newRow);
}

function removeRestockItem(button) {
    const rows = document.querySelectorAll('.restock-item-row');
    if (rows.length > 1) {
        button.closest('.restock-item-row').remove();
    }
}

function updateStatus(orderId) {
    const order = restockOrders.find(o => o.id === orderId);
    if (order) {
        document.querySelector('#updateStatusForm select[name="status"]').value = order.status;
        document.getElementById('updateStatusForm').action = `{{ url_for('admin_update_restock_status', order_id=0) }}`.replace('0', orderId);
    }
}

function viewRestockOrder(orderId) {
    const order = restockOrders.find(o => o.id === orderId);
    if (order) {
        let itemsHtml = '';
        if (order.items && order.items.length > 0) {
            itemsHtml = order.items.map(item => `
                <tr>
                    <td>${item.product.name}</td>
                    <td>${item.quantity_ordered}</td>
                    <td>Rp ${item.unit_cost.toLocaleString('id-ID')}</td>
                    <td>Rp ${(item.quantity_ordered * item.unit_cost).toLocaleString('id-ID')}</td>
                </tr>
            `).join('');
        }
        
        const content = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order ID:</strong> RST-${order.id.toString().padStart(5, '0')}</p>
                    <p><strong>Supplier:</strong> ${order.supplier.name}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Total Amount:</strong> ${order.formatted_total}</p>
                </div>
                <div class="col-md-6">
                    <h6>Dates</h6>
                    <p><strong>Created:</strong> ${new Date(order.created_at).toLocaleDateString('id-ID')}</p>
                    <p><strong>Expected:</strong> ${order.expected_date ? new Date(order.expected_date).toLocaleDateString('id-ID') : '-'}</p>
                    <p><strong>Received:</strong> ${order.received_date ? new Date(order.received_date).toLocaleDateString('id-ID') : '-'}</p>
                </div>
            </div>
            ${order.notes ? `<p><strong>Notes:</strong> ${order.notes}</p>` : ''}
            <h6 class="mt-3">Items</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Unit Cost</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml || '<tr><td colspan="4" class="text-center">No items found</td></tr>'}
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('viewRestockContent').innerHTML = content;
    }
}
</script>
{% endblock %}
