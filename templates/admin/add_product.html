{% extends "admin/base.html" %}

{% block title %}Tambah Produk - Admin{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Tambah Produk Baru</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Nama Produk *</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="category_id" class="form-label">Kategori *</label>
                            <select class="form-select" id="category_id" name="category_id" required>
                                <option value="">Pilih Kategori</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="supplier_id" class="form-label">Supplier</label>
                            <select class="form-select" id="supplier_id" name="supplier_id">
                                <option value="">Pilih Supplier (Opsional)</option>
                                {% for supplier in suppliers %}
                                <option value="{{ supplier.id }}" 
                                        data-contact="{{ supplier.contact_person or '' }}"
                                        data-phone="{{ supplier.phone or '' }}"
                                        data-address="{{ supplier.address or '' }}">
                                    {{ supplier.name }}{% if supplier.company %} - {{ supplier.company }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div id="supplier-info" class="mt-2" style="display: none;">
                                <small class="text-muted">
                                    <div id="supplier-contact"></div>
                                    <div id="supplier-phone"></div>
                                    <div id="supplier-address"></div>
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Deskripsi</label>
                        <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="price" class="form-label">Harga (Rp) *</label>
                            <input type="number" class="form-control" id="price" name="price" step="1000" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="stock_quantity" class="form-label">Stok *</label>
                            <input type="number" class="form-control" id="stock_quantity" name="stock_quantity" min="0" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="brand" class="form-label">Brand</label>
                            <input type="text" class="form-control" id="brand" name="brand">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="weight" class="form-label">Berat (gram)</label>
                            <input type="number" class="form-control" id="weight" name="weight" min="0" step="100">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="length" class="form-label">Panjang (cm)</label>
                            <input type="number" class="form-control" id="length" name="length" min="0" step="0.1">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="width" class="form-label">Lebar (cm)</label>
                            <input type="number" class="form-control" id="width" name="width" min="0" step="0.1">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="height" class="form-label">Tinggi (cm)</label>
                            <input type="number" class="form-control" id="height" name="height" min="0" step="0.1">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="model" name="model">
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="is_featured" name="is_featured">
                                <label class="form-check-label" for="is_featured">
                                    Produk Unggulan
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                <label class="form-check-label" for="is_active">
                                    Aktif
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="images" class="form-label">Gambar Produk</label>
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Upload Gambar (Maksimal 5 foto)</h6>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearAllImages()" id="clearAllBtn" style="display: none;">
                                    <i class="fas fa-trash"></i> Hapus Semua
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="upload-area" id="uploadArea" onclick="document.getElementById('images').click()">
                                    <div class="upload-placeholder text-center py-4">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="mb-2"><strong>Klik untuk memilih gambar</strong></p>
                                        <p class="text-muted small">atau drag & drop gambar ke sini</p>
                                        <p class="text-muted small">Format: JPG, PNG, GIF, WEBP • Maksimal 5MB per file</p>
                                    </div>
                                </div>
                                <input type="file" class="form-control d-none" id="images" name="images" accept="image/*" multiple>
                                
                                <!-- Image Preview Grid -->
                                <div id="imagePreview" class="row mt-3" style="display: none;">
                                    <!-- Preview images will be inserted here -->
                                </div>
                                
                                <input type="hidden" id="selectedThumbnail" name="selected_thumbnail" value="">
                                
                                <!-- Upload Progress -->
                                <div id="uploadProgress" class="mt-3" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin_products') }}" class="btn btn-secondary">Kembali</a>
                        <button type="submit" class="btn btn-primary">Simpan Produk</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.upload-area:hover {
    border-color: #FF6B35;
    background: #fff5f2;
}

.upload-area.drag-over {
    border-color: #FF6B35;
    background: #fff5f2;
    transform: scale(1.02);
}

.image-preview-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    transition: all 0.3s ease;
    height: 100%;
}

.image-preview-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.image-container {
    position: relative;
    height: 180px;
    overflow: hidden;
}

.preview-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.image-preview-card:hover .preview-image {
    transform: scale(1.05);
}

.image-overlay {
    position: absolute;
    top: 0;
    right: 0;
    left: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
    padding: 8px;
}

.image-preview-card:hover .image-overlay {
    opacity: 1;
}

.remove-btn {
    background: rgba(220, 53, 69, 0.9) !important;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
}

.remove-btn:hover {
    background: rgba(220, 53, 69, 1) !important;
    transform: scale(1.1);
}

.thumbnail-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: linear-gradient(135deg, #FF6B35, #FF8C42);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    z-index: 5;
}

.image-info {
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

.form-check-input:checked {
    background-color: #FF6B35;
    border-color: #FF6B35;
}

.form-check-input:focus {
    border-color: #FF8C42;
    box-shadow: 0 0 0 0.25rem rgba(255, 107, 53, 0.25);
}

@media (max-width: 768px) {
    .image-preview-card {
        margin-bottom: 1rem;
    }
    
    .image-container {
        height: 150px;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let selectedFiles = [];
const MAX_FILES = 5;
const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB

// Enhanced image upload with drag & drop and better UI
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    const clearAllBtn = document.getElementById('clearAllBtn');
    
    // Drag & Drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        handleFiles(Array.from(files));
    });
    
    // File input change
    imageInput.addEventListener('change', function(e) {
        handleFiles(Array.from(e.target.files));
    });
});

function handleFiles(files) {
    // Limit to max files
    const remainingSlots = MAX_FILES - selectedFiles.length;
    if (files.length > remainingSlots) {
        alert(`Maksimal ${MAX_FILES} gambar. Anda dapat menambah ${remainingSlots} gambar lagi.`);
        files = files.slice(0, remainingSlots);
    }
    
    let validFiles = [];
    
    for (let file of files) {
        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
            alert(`File ${file.name} terlalu besar! Maksimal 5MB per file.`);
            continue;
        }
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
            alert(`File ${file.name} bukan gambar yang valid!`);
            continue;
        }
        
        validFiles.push(file);
    }
    
    if (validFiles.length === 0) {
        return;
    }
    
    // Add files to selectedFiles array
    selectedFiles = selectedFiles.concat(validFiles);
    
    // Update preview
    updateImagePreview();
    updateUploadArea();
}

function updateImagePreview() {
    const preview = document.getElementById('imagePreview');
    const selectedThumbnailInput = document.getElementById('selectedThumbnail');
    
    if (selectedFiles.length === 0) {
        preview.style.display = 'none';
        preview.innerHTML = '';
        selectedThumbnailInput.value = '';
        return;
    }
    
    preview.style.display = 'block';
    preview.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const col = document.createElement('div');
            col.className = 'col-md-4 col-lg-3 mb-3';
            col.setAttribute('data-index', index);
            
            const isFirst = index === 0;
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);
            
            col.innerHTML = `
                <div class="image-preview-card position-relative">
                    <div class="image-container">
                        <img src="${e.target.result}" alt="Preview ${index + 1}" class="preview-image">
                        <div class="image-overlay">
                            <button type="button" class="btn btn-danger btn-sm remove-btn" onclick="removeImage(${index})" title="Hapus gambar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        ${isFirst ? '<div class="thumbnail-badge">THUMBNAIL</div>' : ''}
                    </div>
                    <div class="image-info p-2">
                        <div class="form-check">
                            <input class="form-check-input thumbnail-radio" type="radio" name="thumbnail_selection" 
                                   id="thumbnail_${index}" value="${index}" ${isFirst ? 'checked' : ''}>
                            <label class="form-check-label fw-bold" for="thumbnail_${index}">
                                Jadikan Thumbnail
                            </label>
                        </div>
                        <small class="text-muted d-block mt-1">
                            ${file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name}
                            <br>(${fileSize} MB)
                        </small>
                    </div>
                </div>
            `;
            
            preview.appendChild(col);
            
            // Set initial thumbnail selection
            if (isFirst && !selectedThumbnailInput.value) {
                selectedThumbnailInput.value = index.toString();
            }
        };
        reader.readAsDataURL(file);
    });
    
    // Add event listeners for thumbnail selection after a short delay
    setTimeout(addThumbnailListeners, 100);
}

function addThumbnailListeners() {
    document.querySelectorAll('.thumbnail-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedThumbnailInput = document.getElementById('selectedThumbnail');
            selectedThumbnailInput.value = this.value;
            
            // Update visual indicators
            document.querySelectorAll('.thumbnail-badge').forEach(badge => badge.remove());
            
            const selectedCard = this.closest('.image-preview-card');
            const badge = document.createElement('div');
            badge.className = 'thumbnail-badge';
            badge.textContent = 'THUMBNAIL';
            selectedCard.querySelector('.image-container').appendChild(badge);
        });
    });
}

function removeImage(index) {
    // Remove from selectedFiles array
    selectedFiles.splice(index, 1);
    
    // Update preview
    updateImagePreview();
    updateUploadArea();
    
    // Clear file input to reset it
    document.getElementById('images').value = '';
}

function clearAllImages() {
    selectedFiles = [];
    document.getElementById('images').value = '';
    document.getElementById('selectedThumbnail').value = '';
    updateImagePreview();
    updateUploadArea();
}

function updateUploadArea() {
    const uploadArea = document.getElementById('uploadArea');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const uploadPlaceholder = uploadArea.querySelector('.upload-placeholder');
    
    if (selectedFiles.length > 0) {
        clearAllBtn.style.display = 'block';
        uploadPlaceholder.innerHTML = `
            <i class="fas fa-images fa-2x text-primary mb-2"></i>
            <p class="mb-2"><strong>${selectedFiles.length}/${MAX_FILES} gambar dipilih</strong></p>
            <p class="text-muted small">Klik untuk menambah gambar lagi</p>
        `;
        
        if (selectedFiles.length >= MAX_FILES) {
            uploadArea.style.pointerEvents = 'none';
            uploadArea.style.opacity = '0.6';
            uploadPlaceholder.innerHTML = `
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <p class="mb-2"><strong>Maksimal ${MAX_FILES} gambar tercapai</strong></p>
                <p class="text-muted small">Hapus gambar untuk menambah yang baru</p>
            `;
        } else {
            uploadArea.style.pointerEvents = 'auto';
            uploadArea.style.opacity = '1';
        }
    } else {
        clearAllBtn.style.display = 'none';
        uploadArea.style.pointerEvents = 'auto';
        uploadArea.style.opacity = '1';
        uploadPlaceholder.innerHTML = `
            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
            <p class="mb-2"><strong>Klik untuk memilih gambar</strong></p>
            <p class="text-muted small">atau drag & drop gambar ke sini</p>
            <p class="text-muted small">Format: JPG, PNG, GIF, WEBP • Maksimal 5MB per file</p>
        `;
    }
}

// Show supplier information when selected
document.getElementById('supplier_id').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const infoDiv = document.getElementById('supplier-info');

    if (this.value && this.value !== '') {
        const contact = selected.dataset.contact;
        const phone = selected.dataset.phone;
        const address = selected.dataset.address;

        let infoHtml = '';
        if (contact) infoHtml += `<div>Contact: ${contact}</div>`;
        if (phone) infoHtml += `<div>Phone: ${phone}</div>`;
        if (address) infoHtml += `<div>Address: ${address}</div>`;

        document.getElementById('supplier-contact').innerHTML = contact ? `Contact: ${contact}` : '';
        document.getElementById('supplier-phone').innerHTML = phone ? `Phone: ${phone}` : '';
        document.getElementById('supplier-address').innerHTML = address ? `Address: ${address}` : '';

        infoDiv.style.display = infoHtml ? 'block' : 'none';
    } else {
        infoDiv.style.display = 'none';
    }
});

// Form validation before submit
document.querySelector('form').addEventListener('submit', function(e) {
    const price = parseFloat(document.getElementById('price').value);
    const stock = parseInt(document.getElementById('stock_quantity').value);

    if (isNaN(price) || price < 0) {
        e.preventDefault();
        alert('Harga harus berupa angka positif!');
        return false;
    }

    if (isNaN(stock) || stock < 0) {
        e.preventDefault();
        alert('Stok harus berupa angka positif!');
        return false;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
    submitBtn.disabled = true;

    // Re-enable if there's an error (form won't submit)
    setTimeout(() => {
        if (submitBtn.disabled) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }, 5000);
});

// Auto-resize textarea
document.getElementById('description').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Format price input (add thousand separators)
document.getElementById('price').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^\d]/g, '');
    if (value) {
        // Remove leading zeros but keep single zero
        value = value.replace(/^0+/, '') || '0';
        e.target.value = value;
    }
});
</script>
{% endblock %}