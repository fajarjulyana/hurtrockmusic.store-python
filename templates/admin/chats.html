
{% extends "admin/base.html" %}
{% block title %}Chat Management - Admin Panel{% endblock %}

{% block extra_head %}
<style>
    /* Professional Chat Management Interface */
    .professional-chat-management {
        background: #f8fafc;
        min-height: 90vh;
        padding: 24px 0;
    }

    [data-theme="dark"] .professional-chat-management {
        background: #0f0f0f;
    }

    .chat-management-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
    }

    /* Header Section */
    .management-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 32px;
        color: white;
        margin-bottom: 32px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
    }

    .header-content h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 8px;
        color: white;
    }

    .header-subtitle {
        font-size: 16px;
        opacity: 0.9;
        margin-bottom: 24px;
    }

    /* Stats Cards */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        background: rgba(255, 255, 255, 0.2);
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: white;
        margin-bottom: 8px;
        display: block;
    }

    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        color: white;
    }

    /* Search and Filter Section */
    .search-filter-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid #e2e8f0;
    }

    [data-theme="dark"] .search-filter-section {
        background: #1a1a1a;
        border-color: #333;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .search-container {
        position: relative;
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 16px 24px 16px 52px;
        border: 2px solid #e2e8f0;
        border-radius: 50px;
        font-size: 16px;
        background: #f8fafc;
        transition: all 0.3s ease;
        color: #2d3748;
    }

    [data-theme="dark"] .search-input {
        background: #2d2d2d;
        border-color: #404040;
        color: #ffffff;
    }

    .search-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    [data-theme="dark"] .search-input:focus {
        background: #333;
    }

    .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #a0aec0;
        font-size: 18px;
    }

    /* Filter Buttons */
    .filter-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-btn {
        background: #f7fafc;
        border: 2px solid #e2e8f0;
        color: #4a5568;
        padding: 10px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    [data-theme="dark"] .filter-btn {
        background: #2d2d2d;
        border-color: #404040;
        color: #a0aec0;
    }

    .filter-btn:hover {
        background: #edf2f7;
        border-color: #cbd5e0;
        color: #2d3748;
        transform: translateY(-1px);
    }

    [data-theme="dark"] .filter-btn:hover {
        background: #404040;
        color: #ffffff;
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* Chat List */
    .chat-list-container {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        border: 1px solid #e2e8f0;
    }

    [data-theme="dark"] .chat-list-container {
        background: #1a1a1a;
        border-color: #333;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .chat-list-header {
        background: #f8fafc;
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
        color: #2d3748;
        font-size: 16px;
    }

    [data-theme="dark"] .chat-list-header {
        background: #2d2d2d;
        border-color: #404040;
        color: #ffffff;
    }

    .chat-list {
        max-height: 70vh;
        overflow-y: auto;
    }

    /* Chat Item */
    .chat-item {
        padding: 20px 24px;
        border-bottom: 1px solid #f1f5f9;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: white;
        display: flex;
        align-items: center;
    }

    [data-theme="dark"] .chat-item {
        background: #1a1a1a;
        border-color: #333;
    }

    .chat-item:hover {
        background: #f8fafc;
        transform: translateX(4px);
        border-left: 4px solid #667eea;
        padding-left: 20px;
    }

    [data-theme="dark"] .chat-item:hover {
        background: #2d2d2d;
    }

    .chat-item:last-child {
        border-bottom: none;
    }

    .chat-item.unread {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 50%, #fff5f5 100%);
        border-left: 4px solid #f56565;
        padding-left: 20px;
    }

    [data-theme="dark"] .chat-item.unread {
        background: linear-gradient(135deg, #2d1b1b 0%, #3d2525 50%, #2d1b1b 100%);
        border-left-color: #f56565;
    }

    .chat-item.unread:hover {
        background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
    }

    /* Customer Avatar */
    .customer-avatar {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
        margin-right: 16px;
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        flex-shrink: 0;
    }

    .customer-avatar.unread {
        background: linear-gradient(135deg, #f56565, #e53e3e);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3); }
        50% { box-shadow: 0 4px 20px rgba(245, 101, 101, 0.5); }
        100% { box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3); }
    }

    /* Chat Info */
    .chat-info {
        flex: 1;
        min-width: 0;
    }

    .customer-name {
        font-size: 16px;
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    [data-theme="dark"] .customer-name {
        color: #ffffff;
    }

    .customer-id {
        font-size: 12px;
        color: #a0aec0;
        background: #f7fafc;
        padding: 2px 8px;
        border-radius: 12px;
    }

    [data-theme="dark"] .customer-id {
        background: #2d2d2d;
        color: #718096;
    }

    .last-message {
        color: #718096;
        font-size: 14px;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.4;
    }

    [data-theme="dark"] .last-message {
        color: #a0aec0;
    }

    .chat-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 12px;
        color: #a0aec0;
    }

    .chat-time {
        font-weight: 500;
    }

    /* Status Indicators */
    .status-indicators {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .unread-badge {
        background: linear-gradient(135deg, #f56565, #e53e3e);
        color: white;
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
        animation: bounce 1s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-4px); }
        60% { transform: translateY(-2px); }
    }

    .online-indicator {
        width: 12px;
        height: 12px;
        background: #48bb78;
        border-radius: 50%;
        border: 2px solid white;
        position: absolute;
        bottom: 2px;
        right: 2px;
        animation: onlinePulse 2s infinite;
    }

    @keyframes onlinePulse {
        0% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0.7); }
        70% { box-shadow: 0 0 0 6px rgba(72, 187, 120, 0); }
        100% { box-shadow: 0 0 0 0 rgba(72, 187, 120, 0); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #718096;
    }

    [data-theme="dark"] .empty-state {
        color: #a0aec0;
    }

    .empty-state-icon {
        font-size: 64px;
        color: #e2e8f0;
        margin-bottom: 20px;
    }

    [data-theme="dark"] .empty-state-icon {
        color: #4a5568;
    }

    .empty-state h3 {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #4a5568;
    }

    [data-theme="dark"] .empty-state h3 {
        color: #e2e8f0;
    }

    .empty-state p {
        font-size: 16px;
        color: #718096;
        line-height: 1.5;
    }

    [data-theme="dark"] .empty-state p {
        color: #a0aec0;
    }

    /* Scrollbar Styling */
    .chat-list::-webkit-scrollbar {
        width: 6px;
    }

    .chat-list::-webkit-scrollbar-track {
        background: #f7fafc;
    }

    [data-theme="dark"] .chat-list::-webkit-scrollbar-track {
        background: #2d2d2d;
    }

    .chat-list::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 10px;
    }

    .chat-list::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    [data-theme="dark"] .chat-list::-webkit-scrollbar-thumb {
        background: #4a5568;
    }

    [data-theme="dark"] .chat-list::-webkit-scrollbar-thumb:hover {
        background: #718096;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .management-header {
            padding: 24px 20px;
        }
        
        .header-content h1 {
            font-size: 24px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .search-filter-section {
            padding: 20px;
        }
        
        .filter-buttons {
            justify-content: center;
        }
        
        .chat-item {
            padding: 16px 20px;
        }
        
        .customer-avatar {
            width: 44px;
            height: 44px;
            font-size: 16px;
            margin-right: 12px;
        }
        
        .customer-name {
            font-size: 15px;
        }
        
        .last-message {
            font-size: 13px;
        }
    }

    @media (max-width: 480px) {
        .chat-management-container {
            padding: 0 16px;
        }
        
        .management-header {
            padding: 20px 16px;
        }
        
        .search-filter-section {
            padding: 16px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .stat-card {
            padding: 16px;
        }
        
        .chat-item {
            padding: 12px 16px;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            font-size: 14px;
            margin-right: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="professional-chat-management">
    <div class="chat-management-container">
        <!-- Header Section -->
        <div class="management-header">
            <div class="header-content">
                <h1>
                    <i class="fas fa-comments me-3"></i>
                    Chat Management
                </h1>
                <p class="header-subtitle">
                    Kelola semua percakapan dengan pelanggan dalam satu dashboard yang terintegrasi
                </p>
                
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="totalChats">{{ chat_rooms|length }}</span>
                        <span class="stat-label">Total Chat</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="unreadChats">
                            {% set unread_total = namespace(value=0) %}
                            {% for room in chat_rooms %}
                                {% set unread_count = room.messages | selectattr('sender_type', 'equalto', 'user') | selectattr('is_read', 'false') | list | length %}
                                {% if unread_count > 0 %}
                                    {% set unread_total.value = unread_total.value + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ unread_total.value }}
                        </span>
                        <span class="stat-label">Belum Dibaca</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="activeToday">
                            {{ chat_rooms | selectattr('last_message_at') | selectattr('last_message_at', 'greaterthan', today_start) | list | length }}
                        </span>
                        <span class="stat-label">Aktif Hari Ini</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">
                            <i class="fas fa-circle text-success" style="font-size: 16px;"></i>
                        </span>
                        <span class="stat-label">Status Online</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="search-filter-section">
            <div class="search-container">
                <input type="text" id="chatSearch" class="search-input" placeholder="Cari berdasarkan nama pelanggan, email, atau pesan...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">
                    <i class="fas fa-list me-2"></i>Semua Chat
                </button>
                <button class="filter-btn" data-filter="unread">
                    <i class="fas fa-exclamation-circle me-2"></i>Belum Dibaca
                </button>
                <button class="filter-btn" data-filter="today">
                    <i class="fas fa-clock me-2"></i>Hari Ini
                </button>
                <button class="filter-btn" data-filter="recent">
                    <i class="fas fa-history me-2"></i>Terbaru
                </button>
            </div>
        </div>

        <!-- Chat List -->
        <div class="chat-list-container">
            <div class="chat-list-header">
                <i class="fas fa-inbox me-2"></i>
                Daftar Percakapan Pelanggan
            </div>
            
            <div class="chat-list" id="chatList">
                {% if chat_rooms %}
                    {% for chat_room in chat_rooms %}
                        {% set unread_count = chat_room.messages | selectattr('sender_type', 'equalto', 'user') | selectattr('is_read', 'false') | list | length %}
                        {% set last_message = chat_room.messages[-1] if chat_room.messages else None %}
                        
                        <div class="chat-item{% if unread_count > 0 %} unread{% endif %}" 
                             data-room-id="{{ chat_room.id }}"
                             data-customer-name="{{ chat_room.user.name|lower }}"
                             data-customer-email="{{ chat_room.user.email|lower }}"
                             data-last-message="{{ last_message.message|lower if last_message else '' }}"
                             data-unread="{{ 'true' if unread_count > 0 else 'false' }}"
                             data-today="{{ 'true' if chat_room.last_message_at and chat_room.last_message_at.date() == today.date() else 'false' }}"
                             onclick="window.location.href='/admin/chat/{{ chat_room.id }}'">
                            
                            <div class="position-relative">
                                <div class="customer-avatar{% if unread_count > 0 %} unread{% endif %}">
                                    {{ chat_room.user.name[0]|upper }}
                                </div>
                                <div class="online-indicator"></div>
                            </div>
                            
                            <div class="chat-info">
                                <div class="customer-name">
                                    {{ chat_room.user.name }}
                                    <span class="customer-id">ID: {{ chat_room.id }}</span>
                                </div>
                                <div class="last-message">
                                    {% if last_message %}
                                        {{ last_message.message[:80] }}
                                        {% if last_message.message|length > 80 %}...{% endif %}
                                    {% else %}
                                        <em>Belum ada pesan</em>
                                    {% endif %}
                                </div>
                                <div class="chat-meta">
                                    <span class="chat-time">
                                        {% if last_message %}
                                            {{ last_message.created_at.strftime('%d/%m %H:%M') }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </span>
                                    <div class="status-indicators">
                                        {% if unread_count > 0 %}
                                            <span class="unread-badge">{{ unread_count }}</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3>Belum Ada Percakapan</h3>
                        <p>Pelanggan belum memulai chat dengan Anda.<br>Chat akan muncul di sini ketika pelanggan mengirim pesan pertama.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatSearch = document.getElementById('chatSearch');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const chatItems = document.querySelectorAll('.chat-item');
    const chatList = document.getElementById('chatList');

    // Search functionality
    if (chatSearch) {
        chatSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            chatItems.forEach(function(item) {
                const customerName = item.dataset.customerName || '';
                const customerEmail = item.dataset.customerEmail || '';
                const lastMessage = item.dataset.lastMessage || '';
                
                const matches = customerName.includes(searchTerm) || 
                              customerEmail.includes(searchTerm) || 
                              lastMessage.includes(searchTerm);
                
                if (matches || searchTerm === '') {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateEmptyState();
        });
    }

    // Filter functionality
    filterBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            // Update active state
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.dataset.filter;
            
            chatItems.forEach(function(item) {
                let show = false;
                
                switch(filter) {
                    case 'all':
                        show = true;
                        break;
                    case 'unread':
                        show = item.dataset.unread === 'true';
                        break;
                    case 'today':
                        show = item.dataset.today === 'true';
                        break;
                    case 'recent':
                        // Show items from last 3 days (this would need server-side logic)
                        show = true;
                        break;
                }
                
                if (show) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            updateEmptyState();
        });
    });

    // Update empty state
    function updateEmptyState() {
        const visibleItems = Array.from(chatItems).filter(item => 
            item.style.display !== 'none'
        );
        
        if (visibleItems.length === 0 && chatItems.length > 0) {
            if (!document.querySelector('.no-results')) {
                const noResults = document.createElement('div');
                noResults.className = 'empty-state no-results';
                noResults.innerHTML = `
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3>Tidak Ada Hasil</h3>
                    <p>Tidak ditemukan chat yang sesuai dengan kriteria pencarian atau filter Anda.</p>
                `;
                chatList.appendChild(noResults);
            }
        } else {
            const noResults = document.querySelector('.no-results');
            if (noResults) {
                noResults.remove();
            }
        }
    }

    // Auto refresh every 30 seconds
    setInterval(function() {
        // Only refresh if user is not actively searching
        if (!chatSearch || chatSearch.value.trim() === '') {
            location.reload();
        }
    }, 30000);
});
</script>
{% endblock %}
