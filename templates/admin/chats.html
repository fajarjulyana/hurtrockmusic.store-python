
{% extends "admin/base.html" %}

{% block title %}Chat Center - Admin{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
.chat-center {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.chat-search-header {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    color: white;
    padding: 24px;
    border-radius: 12px 12px 0 0;
}
.search-box {
    position: relative;
    margin-top: 16px;
}
.search-input {
    width: 100%;
    padding: 12px 45px 12px 16px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.15);
    color: white;
    font-size: 16px;
    backdrop-filter: blur(10px);
}
.search-input::placeholder {
    color: rgba(255,255,255,0.7);
}
.search-input:focus {
    outline: none;
    background: rgba(255,255,255,0.25);
    box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
}
.search-icon {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: rgba(255,255,255,0.7);
}
.chat-filters {
    padding: 16px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}
.filter-btn {
    background: white;
    border: 1px solid #d1d5db;
    color: #6b7280;
    padding: 8px 16px;
    border-radius: 20px;
    margin-right: 8px;
    margin-bottom: 8px;
    font-size: 14px;
    transition: all 0.2s;
}
.filter-btn:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
}
.filter-btn.active {
    background: #4f46e5;
    border-color: #4f46e5;
    color: white;
}
.chat-list {
    max-height: 70vh;
    overflow-y: auto;
}
.chat-item {
    padding: 16px 24px;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
    border-left: 4px solid transparent;
    margin-bottom: 2px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    user-select: none;
}
.chat-item:hover {
    background: #f8f9fa !important;
    border-left-color: #007bff;
    transform: translateX(4px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
.chat-item:active {
    transform: translateX(2px);
    background: #e3f2fd !important;
}
.chat-item:focus {
    outline: 2px solid #4f46e5;
    outline-offset: 2px;
}
.chat-item.unread {
    background: #fef3cd;
    border-left: 4px solid #ff6b35;
}
.chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 18px;
}
.chat-info {
    margin-left: 12px;
    flex: 1;
}
.customer-name {
    font-weight: 600;
    color: #111827;
    margin-bottom: 4px;
}
.last-message {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.chat-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #9ca3af;
}
.unread-badge {
    background: #ff6b35;
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 11px;
    font-weight: 600;
    min-width: 20px;
    text-align: center;
}
.online-indicator {
    width: 12px;
    height: 12px;
    background: #10b981;
    border-radius: 50%;
    border: 2px solid white;
    position: absolute;
    bottom: 2px;
    right: 2px;
}
.stats-bar {
    padding: 16px 24px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.stat-item {
    text-align: center;
    flex: 1;
}
.stat-number {
    font-size: 24px;
    font-weight: 700;
    color: #4f46e5;
}
.stat-label {
    font-size: 12px;
    color: #6b7280;
    margin-top: 4px;
}
.empty-state {
    text-align: center;
    padding: 60px 24px;
    color: #6b7280;
}
.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    color: #d1d5db;
}
</style>
{% endblock %}

{% block content %}
<div class="chat-center">
    <div class="chat-search-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="mb-2">Chat Center</h2>
                <p class="mb-0 opacity-90">Kelola percakapan dengan pelanggan secara real-time</p>
            </div>
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">Online</span>
                <div class="text-end">
                    <div class="fw-bold">{{ chat_rooms|length }}</div>
                    <small class="opacity-90">Chat Aktif</small>
                </div>
            </div>
        </div>
        <div class="search-box">
            <input type="text" id="chatSearch" class="search-input" placeholder="Cari berdasarkan nama, email, atau pesan...">
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>
    
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-number" id="totalChats">{{ chat_rooms|length }}</div>
            <div class="stat-label">Total Chat</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="unreadChats">{% set unread_total = namespace(value=0) %}{% for room in chat_rooms %}{% set unread_count = room.messages | selectattr('sender_type', 'equalto', 'user') | selectattr('is_read', 'false') | list | length %}{% if unread_count > 0 %}{% set unread_total.value = unread_total.value + 1 %}{% endif %}{% endfor %}{{ unread_total.value }}</div>
            <div class="stat-label">Belum Dibaca</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="activeToday">{{ chat_rooms | selectattr('last_message_at') | selectattr('last_message_at', 'greaterthan', today_start) | list | length }}</div>
            <div class="stat-label">Aktif Hari Ini</div>
        </div>
    </div>
    
    <div class="chat-filters">
        <button class="filter-btn active" data-filter="all">Semua Chat</button>
        <button class="filter-btn" data-filter="unread">Belum Dibaca</button>
        <button class="filter-btn" data-filter="today">Hari Ini</button>
        <button class="filter-btn" data-filter="recent">Terbaru</button>
    </div>

    <div class="chat-list" id="chatList">
        {% for chat_room in chat_rooms %}
        {% set unread_count = chat_room.messages | selectattr('sender_type', 'equalto', 'user') | selectattr('is_read', 'false') | list | length %}
        {% set last_message = chat_room.messages[-1] if chat_room.messages else None %}
        <div class="chat-item{% if unread_count > 0 %} unread{% endif %}" 
             data-room-id="{{ chat_room.id }}"
             data-customer-name="{{ chat_room.user.name|lower }}"
             data-customer-email="{{ chat_room.user.email|lower }}"
             data-last-message="{{ last_message.message|lower if last_message else '' }}"
             data-unread="{{ 'true' if unread_count > 0 else 'false' }}"
             data-today="{{ 'true' if chat_room.last_message_at and chat_room.last_message_at.date() == today.date() else 'false' }}"
             style="cursor: pointer; position: relative; z-index: 1;"
             onclick="window.location.href='/admin/chat/{{ chat_room.id }}'"</old_str>
            <div class="d-flex align-items-center w-100">
                <div class="position-relative">
                    <div class="chat-avatar">
                        {{ chat_room.user.name[0]|upper }}
                    </div>
                    <div class="online-indicator"></div>
                </div>
                <div class="chat-info flex-grow-1">
                    <div class="customer-name">{{ chat_room.user.name }} 
                        <small class="text-muted">(ID: {{ chat_room.id }})</small>
                    </div>
                    <div class="last-message">
                        {% if last_message %}
                            {% if last_message.sender_type == 'admin' %}
                                <i class="fas fa-reply me-1 text-primary"></i>
                            {% else %}
                                <i class="fas fa-comment me-1 text-success"></i>
                            {% endif %}
                            {{ last_message.message[:60] }}{% if last_message.message|length > 60 %}...{% endif %}
                        {% else %}
                            <em class="text-muted">Belum ada pesan</em>
                        {% endif %}
                    </div>
                    <div class="chat-meta">
                        <span class="text-muted">{{ chat_room.user.email }}</span>
                        <span class="text-muted">{{ last_message.created_at.strftime('%H:%M') if last_message else chat_room.created_at.strftime('%H:%M') }}</span>
                    </div>
                </div>
                <div class="d-flex flex-column align-items-end">
                    {% if unread_count > 0 %}
                    <div class="unread-badge mb-1">{{ unread_count }}</div>
                    {% endif %}
                    <small class="text-muted">
                        <i class="fas fa-chevron-right"></i>
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not chat_rooms %}
        <div class="empty-state text-center py-5">
            <div class="empty-icon mb-3">
                <i class="fas fa-comments fa-3x text-muted"></i>
            </div>
            <h5 class="text-muted">Belum Ada Chat</h5>
            <p class="text-muted">Chat akan muncul ketika pelanggan mulai mengirim pesan melalui floating chat.</p>
            <small class="text-muted">ðŸ’¡ Tip: Customer bisa memulai chat dari halaman produk atau menggunakan floating chat widget</small>
        </div>
        {% else %}
        <div class="text-muted px-3 py-2 small">
            <i class="fas fa-info-circle me-1"></i>
            Klik pada chat untuk membuka percakapan dengan customer
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const socket = io();
let allChatItems = [];
let currentFilter = 'all';

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    allChatItems = Array.from(document.querySelectorAll('.chat-item'));
    initializeSearchAndFilters();
    updateStats();
});

// Join admin room
socket.emit('join', {});

// Handle new messages
socket.on('new_message', function(data) {
    if (data.sender_type === 'user') {
        showToast(`ðŸ’¬ ${data.user_name || 'Pelanggan'}: ${data.message.substring(0, 40)}${data.message.length > 40 ? '...' : ''}`, 'info');
        updateChatRoomBadge(data.room_id);
        updateStats();
        
        // Play notification sound
        playNotificationSound();
    }
});

// Initialize search and filters
function initializeSearchAndFilters() {
    const searchInput = document.getElementById('chatSearch');
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    // Search functionality
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            filterChats(query, currentFilter);
        });
        
        // Clear search on escape
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                this.value = '';
                filterChats('', currentFilter);
                this.blur();
            }
        });
    }
    
    // Filter buttons
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active filter button
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            currentFilter = this.dataset.filter;
            const query = searchInput ? searchInput.value.toLowerCase().trim() : '';
            filterChats(query, currentFilter);
        });
    });
}

// Filter chats based on search query and filter type
function filterChats(query, filter) {
    let visibleCount = 0;
    
    allChatItems.forEach(item => {
        let matchesSearch = true;
        let matchesFilter = true;
        
        // Search filter
        if (query) {
            const customerName = item.dataset.customerName || '';
            const customerEmail = item.dataset.customerEmail || '';
            const lastMessage = item.dataset.lastMessage || '';
            
            matchesSearch = customerName.includes(query) || 
                           customerEmail.includes(query) || 
                           lastMessage.includes(query);
        }
        
        // Type filter
        switch (filter) {
            case 'unread':
                matchesFilter = item.dataset.unread === 'true';
                break;
            case 'today':
                matchesFilter = item.dataset.today === 'true';
                break;
            case 'recent':
                // Show items from last 24 hours
                matchesFilter = item.dataset.today === 'true';
                break;
            case 'all':
            default:
                matchesFilter = true;
                break;
        }
        
        const shouldShow = matchesSearch && matchesFilter;
        item.style.display = shouldShow ? 'block' : 'none';
        
        if (shouldShow) visibleCount++;
    });
    
    // Show empty state if no results
    toggleEmptyState(visibleCount === 0 && allChatItems.length > 0);
}

// Toggle empty state for search results
function toggleEmptyState(show) {
    let emptyState = document.getElementById('searchEmptyState');
    
    if (show && !emptyState) {
        emptyState = document.createElement('div');
        emptyState.id = 'searchEmptyState';
        emptyState.className = 'empty-state';
        emptyState.innerHTML = `
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h5>Tidak Ada Hasil</h5>
            <p>Coba gunakan kata kunci yang berbeda atau ubah filter pencarian.</p>
        `;
        document.getElementById('chatList').appendChild(emptyState);
    } else if (!show && emptyState) {
        emptyState.remove();
    }
}

// Update chat room badge for new messages
function updateChatRoomBadge(roomId) {
    const chatItem = document.querySelector(`[data-room-id="${roomId}"]`);
    if (chatItem) {
        // Add unread class
        chatItem.classList.add('unread');
        chatItem.dataset.unread = 'true';
        
        // Update or create unread badge
        let badge = chatItem.querySelector('.unread-badge');
        if (!badge) {
            badge = document.createElement('div');
            badge.className = 'unread-badge';
            badge.textContent = '1';
            chatItem.querySelector('.d-flex').appendChild(badge);
        } else {
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
        }
        
        // Move to top of list
        const chatList = document.getElementById('chatList');
        chatList.insertBefore(chatItem, chatList.firstChild);
    }
}

// Update statistics
function updateStats() {
    const totalChats = allChatItems.length;
    const unreadChats = allChatItems.filter(item => item.dataset.unread === 'true').length;
    const activeToday = allChatItems.filter(item => item.dataset.today === 'true').length;
    
    document.getElementById('totalChats').textContent = totalChats;
    document.getElementById('unreadChats').textContent = unreadChats;
    document.getElementById('activeToday').textContent = activeToday;
}

// Add hover effects for chat items
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸŸ¢ DOM loaded, setting up chat item hover effects');
    
    // Add visual feedback on hover for chat items
    const chatItems = document.querySelectorAll('.chat-item');
    console.log('ðŸ“‹ Found chat items:', chatItems.length);
    
    chatItems.forEach((item, index) => {
        const roomId = item.getAttribute('data-room-id');
        console.log(`ðŸ’¬ Chat item ${index + 1}: Room ID = ${roomId}`);
        
        // Add visual feedback on hover
        item.addEventListener('mouseenter', function() {
            if (!this.classList.contains('unread')) {
                this.style.borderLeftColor = '#007bff';
                this.style.backgroundColor = '#f8f9fa';
            }
        });
        
        item.addEventListener('mouseleave', function() {
            if (!this.classList.contains('unread')) {
                this.style.borderLeftColor = 'transparent';
                this.style.backgroundColor = '';
            }
        });
        
        // Add tooltip
        const customerNameElement = item.querySelector('.customer-name');
        const customerName = customerNameElement ? customerNameElement.textContent.trim() : 'Customer';
        item.title = `Klik untuk membuka chat dengan ${customerName}`;
        
        // Make it focusable for keyboard navigation
        item.setAttribute('tabindex', '0');
        
        // Handle keyboard navigation
        item.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                window.location.href = `/admin/chat/${roomId}`;
            }
        });
    });
});

// Play notification sound
function playNotificationSound() {
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmccBFJ/2Z6zfD8HMorQ+dmWTAoVY7nr4qRXGAg+ltryxnkpBSl+zPLaizsIGGS57OScTgwOUarm7blbGAk7k9n1unAiBC13yO/eizEIHWq+8+OWSwsUXbDo9KVZGgpBmOH1uzMJAGQJ4/+AdjABgdSDGAAkICAQAgdAAAAsAyNjbGF0A3Nkawsfa5xdL2hJgHMAExO2Cy6cRKFEUAAAmzFFTjUICJKPVIAKC2xZxJNRXWAJAKMwLJN3lxhUAAlQr85LIKyVIXfz8AZeBJULGGoFhAJgVrwzqDw5rRtgJQZMpAyKQZ8b5hT9xtaDOxUyZf8S5/ZHNQAjNhV9U+AAUOOhAECAYAB8AlQRBBDABhAggAgxAAAQAAkHBAJAEAAIIgAAISCRLrGAKdU0EAjXNwAAhiIVD9f4hhsHLRf6jdBBhiULRvdtN/QgAiSGo/8tABQAAC8vVMNV8e8JCQhg');
        audio.volume = 0.3;
        audio.play().catch(() => {});
    } catch (e) {
        // Ignore audio errors
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'success' : 
                   type === 'error' || type === 'danger' ? 'danger' : 
                   type === 'warning' ? 'warning' : 'info';
    
    const toast = document.createElement('div');
    toast.id = toastId;
    toast.className = `toast align-items-center text-white bg-${bgClass} border-0 mb-2`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 5000
    });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + K to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        document.getElementById('chatSearch')?.focus();
    }
    
    // Ctrl/Cmd + 1-4 for filters
    if ((e.ctrlKey || e.metaKey) && ['1', '2', '3', '4'].includes(e.key)) {
        e.preventDefault();
        const filterButtons = document.querySelectorAll('.filter-btn');
        const index = parseInt(e.key) - 1;
        if (filterButtons[index]) {
            filterButtons[index].click();
        }
    }
});

// Auto-refresh stats every 30 seconds
setInterval(() => {
    // Only refresh if page is visible
    if (!document.hidden) {
        updateStats();
    }
}, 30000);
</script>
{% endblock %}
